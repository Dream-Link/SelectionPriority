<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rajasthan Selection Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Core CSS --- */
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --error: #ef4444; --filter-active: #059669; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg); color: var(--text); padding-bottom: 60px; }
        
        .header { background: linear-gradient(135deg, #1e40af, #3b82f6); color: white; padding: 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .container { width: 95%; max-width: 900px; margin: 20px auto; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        
        /* Success Message */
        .success-card { text-align: center; background: #dcfce7; border: 1px solid #22c55e; display: none; }

        .form-group { margin-bottom: 20px; }
        label.main-label { font-weight: 600; display: block; margin-bottom: 8px; color: #334155; }
        
        /* Telegram Link Style */
        .telegram-link {
            font-size: 0.75rem; color: #2563eb; font-weight: 500; cursor: pointer; text-decoration: none;
            background: #eff6ff; padding: 2px 6px; border-radius: 4px; margin-left: 5px; border: 1px solid #bfdbfe;
        }
        .telegram-link:hover { background: #dbeafe; text-decoration: underline; }

        input, select { width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 1rem; outline: none; background: #f8fafc; }
        input:focus, select:focus { border-color: var(--primary); background: #fff; }
        
        /* Checkbox Grid */
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
        .chip-option input { display: none; }
        .chip-label { display: flex; align-items: center; justify-content: center; padding: 10px; background: #fff; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; text-align: center; height: 100%; transition: 0.2s; }
        .chip-option input:checked + .chip-label { background: #eff6ff; border-color: var(--primary); color: var(--primary); font-weight: 700; box-shadow: 0 2px 5px rgba(37, 99, 235, 0.2); }

        /* Child Size Filter */
        .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 6px; }
        .filter-chip-label { 
            background: #f1f5f9; border: 1px solid #e2e8f0; color: #64748b; 
            padding: 4px 2px; font-size: 11px; border-radius: 4px; min-height: 30px; 
        }
        .filter-option input:checked + .filter-chip-label { background: #d1fae5; border-color: var(--filter-active); color: var(--filter-active); font-weight: 700; }

        .btn-submit { width: 100%; background: var(--primary); color: white; padding: 14px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .btn-submit:disabled { background: #94a3b8; cursor: not-allowed; }

        /* Table Styles */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #334155; color: white; padding: 12px; font-size: 13px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; font-size: 12px; vertical-align: top; }
        
        .cat-badge { font-size: 10px; background: #e0f2fe; color: #0369a1; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: inline-block; margin-top: 2px; }

        .data-badge { 
            display: inline-block; background: #f8fafc; padding: 6px 10px; 
            border-radius: 6px; margin: 4px; border: 1px solid #e2e8f0;
            min-width: 100px; vertical-align: top;
        }
        .badge-exam { font-weight: 700; font-size: 12px; display: block; color: #1e293b; }
        .badge-roll { font-size: 11px; color: #64748b; display: block; margin-top: 2px; }
        .badge-marks { font-size: 11px; color: var(--primary); font-weight: 600; display: block; margin-top: 2px; border-top: 1px dashed #e2e8f0; padding-top:2px; }

        /* Modal System */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 380px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .error-msg { color: var(--error); font-size: 0.8rem; display: none; margin-top: 5px; text-align: center; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-modal { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-confirm { background: var(--primary); color: white; } 
        .btn-cancel { background: #e2e8f0; color: #333; }
        .btn-final { background: #16a34a; color: white; } 

        .confirm-list { text-align: left; background: #f8fafc; padding: 10px; border-radius: 6px; font-size: 0.9rem; margin: 10px 0; list-style: none; border: 1px solid #e2e8f0; }
        .confirm-list li { margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 2px; }
        .warning-box { background: #fef2f2; color: #b91c1c; font-size: 0.85rem; padding: 10px; border-radius: 6px; border: 1px solid #fecaca; margin-top: 10px; font-weight: 600; }
    </style>
</head>
<body>

    <div class="header">
        <h2>Rajasthan Selection Survey</h2>
        <p>Live</p>
    </div>

    <div class="container">
        
        <div class="card success-card" id="alreadySubmittedMsg">
            <h3 style="color:#15803d;">‚úÖ ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶!</h3>
            <p style="color:#166534;">‡§Ü‡§™‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡§Æ‡§æ ‡§π‡•ã ‡§ö‡•Å‡§ï‡§æ ‡§π‡•à‡•§</p>
            <p style="font-size:12px; margin-top:5px; opacity:0.8;">(Duplicate entries are disabled)</p>
        </div>

        <div class="card" id="formCard">
            <h3 style="margin-bottom:15px; color:var(--primary);">üìù ‡§Ö‡§™‡§®‡§æ ‡§°‡•á‡§ü‡§æ ‡§≠‡§∞‡•á‡§Ç</h3>
            <form id="surveyForm">
                <div class="form-group">
                    <label class="main-label">‡§®‡§æ‡§Æ (Name)</label>
                    <input type="text" id="userName" placeholder="Ex: DreamLink" required>
                </div>

                <div class="form-group">
                    <label class="main-label">‡§∂‡•ç‡§∞‡•á‡§£‡•Ä (Category)</label>
                    <select id="userCategory" required>
                        <option value="">-- Select Category --</option>
                        <option value="GEN">GEN</option>
                        <option value="OBC">OBC</option>
                        <option value="EWS">EWS</option>
                        <option value="SC">SC</option>
                        <option value="ST">ST</option>
                        <option value="MBC">MBC</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="main-label">
                        ‡§ï‡§ø‡§® ‡§è‡§ó‡•ç‡•õ‡§æ‡§Æ ‡§Æ‡•á‡§Ç Selection ‡§ï‡•Ä ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§®‡§æ ‡§π‡•à?
                        <a href="https://t.me/Dreamlinkmp" target="_blank" class="telegram-link">Join Telegram for Add Exam Type</a>
                    </label>
                    <div class="checkbox-grid" id="dynamicExamGrid">
                        <div style="padding:20px; color:gray; grid-column: 1/-1; text-align:center;">Loading exams...</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="main-label">‡§ú‡•â‡§á‡§®‡§ø‡§Ç‡§ó ‡§™‡•ç‡§∞‡§æ‡§•‡§Æ‡§ø‡§ï‡§§‡§æ (Priority)</label>
                    <select id="preference" required>
                        <option value="">-- ‡§™‡§π‡§≤‡•á ‡§è‡§ó‡•ç‡•õ‡§æ‡§Æ ‡§ü‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç --</option>
                    </select>
                </div>

                <button type="submit" class="btn-submit" id="preSubmitBtn">Submit Data</button>
            </form>
        </div>

        <div class="card" style="border-left: 5px solid var(--filter-active);">
            <div class="filter-header">
                <h3 style="color: var(--text); font-size: 1.1rem;">üîç ‡§ï‡•â‡§Æ‡§® ‡§ï‡•à‡§Ç‡§°‡§ø‡§°‡•á‡§ü ‡§´‡§ø‡§≤‡•ç‡§ü‡§∞</h3>
                <span class="filter-count" id="resultCount" style="font-size:0.8rem;">Loading...</span>
            </div>
            <div class="filter-grid" id="dynamicFilterGrid">
                <div style="padding:10px; color:gray; font-size:10px;">Loading filters...</div>
            </div>
        </div>

        <div class="card" style="padding:0; overflow:hidden;">
            <div class="table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Name & Category</th>
                            <th>Selected In (Roll & Marks)</th>
                            <th>Joining Priority</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div id="noDataMsg" style="padding:20px; text-align:center; color:#64748b; display:none;">‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="detailsModal">
        <div class="modal-box">
            <h3 style="text-align:center; margin-bottom:15px;" id="modalExamName">Details</h3>
            <div style="margin-bottom:10px;">
                <label style="font-size:0.8rem; font-weight:bold;">Roll Number</label>
                <input type="text" id="rollInput" placeholder="e.g. 123456" maxlength="12">
            </div>
            <div style="margin-bottom:10px;">
                <label style="font-size:0.8rem; font-weight:bold;">Marks (Ank)</label>
                <input type="number" id="marksInput" placeholder="e.g. 150.5" step="any">
            </div>
            <div class="error-msg" id="modalError">Error</div>
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" id="cancelBtn">Cancel</button>
                <button class="btn-modal btn-confirm" id="confirmBtn">Done</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="submitConfirmModal">
        <div class="modal-box">
            <h3 style="text-align:center; color:var(--text);">Confirm Details</h3>
            
            <ul class="confirm-list" id="confirmSummary">
                </ul>

            <div class="warning-box">
                ‚ö†Ô∏è Warning: ‡§ß‡•ç‡§Ø‡§æ‡§®‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§à‡§Æ‡§æ‡§®‡§¶‡§æ‡§∞‡•Ä ‡§∏‡•á ‡§°‡§æ‡§ü‡§æ ‡§≠‡§∞‡•á, ‡§è‡§ï ‡§°‡§ø‡§µ‡§æ‡§á‡§∏ ‡§∏‡•á ‡§ï‡•á‡§µ‡§≤ ‡§è‡§ï ‡§¨‡§æ‡§∞ ‡§π‡•Ä ‡§≠‡§∞‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§
            </div>

            <div class="modal-actions">
                <button class="btn-modal btn-cancel" id="cancelFinalBtn">Edit</button>
                <button class="btn-modal btn-final" id="finalSubmitBtn">Final Submit</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, where, getDocs } 
            from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA4Vx053wPlyy0CMVQVSV3T26Ib359obTs",
            authDomain: "selectionexam-96832.firebaseapp.com",
            projectId: "selectionexam-96832",
            storageBucket: "selectionexam-96832.firebasestorage.app",
            messagingSenderId: "591171111866",
            appId: "1:591171111866:web:a721c6e7aa51339412ab83"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let verifiedData = {}; 
        let currentCheckbox = null;
        let globalServerData = []; 

        const formCard = document.getElementById('formCard');
        const alreadySubmittedMsg = document.getElementById('alreadySubmittedMsg');
        const submitConfirmModal = document.getElementById('submitConfirmModal');
        const finalSubmitBtn = document.getElementById('finalSubmitBtn');
        const examGrid = document.getElementById('dynamicExamGrid');
        const filterGrid = document.getElementById('dynamicFilterGrid');

        // --- DEVICE ID LOGIC ---
        function getOrCreateDeviceId() {
            let id = localStorage.getItem('unique_device_id');
            if (!id) {
                id = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('unique_device_id', id);
            }
            return id;
        }
        const myDeviceId = getOrCreateDeviceId();

        async function checkSubmissionStatus() {
            const qCheck = query(collection(db, "candidates_data"), where("deviceId", "==", myDeviceId));
            const querySnapshot = await getDocs(qCheck);

            if (!querySnapshot.empty) {
                formCard.style.display = 'none';
                alreadySubmittedMsg.style.display = 'block';
            } else {
                formCard.style.display = 'block';
                alreadySubmittedMsg.style.display = 'none';
            }
        }
        checkSubmissionStatus();

        // --- LOAD EXAMS ---
        const qExams = query(collection(db, "exam_list"), orderBy("name"));
        onSnapshot(qExams, (snapshot) => {
            examGrid.innerHTML = ""; filterGrid.innerHTML = "";

            if (snapshot.empty) {
                examGrid.innerHTML = "<div style='color:red'>No exams. Add from Admin Panel.</div>";
                return;
            }

            snapshot.forEach((doc) => {
                const examName = doc.data().name;
                const div1 = document.createElement('div');
                div1.className = "chip-option";
                div1.innerHTML = `<input type="checkbox" id="ex_${examName}" value="${examName}" class="exam-opt"><label for="ex_${examName}" class="chip-label">${examName}</label>`;
                examGrid.appendChild(div1);

                const div2 = document.createElement('div');
                div2.className = "chip-option filter-option";
                div2.innerHTML = `<input type="checkbox" id="fil_${examName}" value="${examName}" class="filter-opt"><label for="fil_${examName}" class="chip-label filter-chip-label">${examName}</label>`;
                filterGrid.appendChild(div2);
            });
            attachListeners();
        });

        // --- LOAD DATA ---
        const qData = query(collection(db, "candidates_data"), orderBy("timestamp", "desc"));
        onSnapshot(qData, (snapshot) => {
            globalServerData = [];
            snapshot.forEach((doc) => globalServerData.push(doc.data()));
            applyFilters();
            checkSubmissionStatus(); 
        });

        function attachListeners() {
            document.querySelectorAll('.exam-opt').forEach(box => {
                box.addEventListener('change', function() {
                    if (this.checked) { currentCheckbox = this; openModal(this.value); } 
                    else { delete verifiedData[this.value]; updatePreferenceOptions(); }
                });
            });
            document.querySelectorAll('.filter-opt').forEach(box => {
                box.addEventListener('change', applyFilters);
            });
        }

        // --- INPUT MODAL ---
        const modal = document.getElementById('detailsModal');
        const rollInput = document.getElementById('rollInput');
        const marksInput = document.getElementById('marksInput');
        const prefSelect = document.getElementById('preference');

        function openModal(examName) {
            document.getElementById('modalExamName').innerText = examName;
            rollInput.value = ''; marksInput.value = '';
            document.getElementById('modalError').style.display = 'none';
            modal.style.display = 'flex'; rollInput.focus();
        }
        document.getElementById('cancelBtn').addEventListener('click', () => {
            if(currentCheckbox) currentCheckbox.checked = false;
            modal.style.display = 'none';
        });
        document.getElementById('confirmBtn').addEventListener('click', () => {
            const roll = rollInput.value.trim();
            const marks = marksInput.value.trim();
            if (!/^\d+$/.test(roll) || roll.length < 4) return showError("Invalid Roll Number");
            if (!marks || isNaN(marks)) return showError("Invalid Marks");
            verifiedData[currentCheckbox.value] = { roll, marks };
            updatePreferenceOptions();
            modal.style.display = 'none';
        });
        function showError(msg) {
            const err = document.getElementById('modalError');
            err.innerText = msg; err.style.display = 'block';
        }
        function updatePreferenceOptions() {
            prefSelect.innerHTML = '<option value="">-- ‡§™‡•ç‡§∞‡§æ‡§•‡§Æ‡§ø‡§ï‡§§‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç --</option>';
            let hasData = false;
            for (const exam in verifiedData) {
                hasData = true;
                let opt = document.createElement('option');
                opt.value = exam; opt.innerText = exam;
                prefSelect.appendChild(opt);
            }
            if(!hasData) prefSelect.innerHTML = '<option value="">-- ‡§™‡§π‡§≤‡•á ‡§è‡§ó‡•ç‡•õ‡§æ‡§Æ ‡§ü‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç --</option>';
        }

        // --- SUBMIT FLOW ---
        document.getElementById('surveyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const qCheck = query(collection(db, "candidates_data"), where("deviceId", "==", myDeviceId));
            const snapshot = await getDocs(qCheck);
            if (!snapshot.empty) {
                alert("Already Submitted!"); location.reload(); return;
            }

            const name = document.getElementById('userName').value;
            const category = document.getElementById('userCategory').value; // GET CATEGORY
            const pref = document.getElementById('preference').value;
            
            if (!category) return alert("Please select Category");
            if (!pref) return alert("Please select preference");

            const confirmList = document.getElementById('confirmSummary');
            confirmList.innerHTML = `<li><strong>Name:</strong> ${name} <span style="font-size:11px; background:#eee; padding:2px 5px;">${category}</span></li>`;
            Object.entries(verifiedData).forEach(([exam, details]) => {
                confirmList.innerHTML += `<li><strong>${exam}:</strong> Roll ${details.roll} (${details.marks} M)</li>`;
            });
            confirmList.innerHTML += `<li style="color:green; margin-top:5px;"><strong>Priority:</strong> ${pref}</li>`;
            submitConfirmModal.style.display = 'flex';
        });

        document.getElementById('cancelFinalBtn').addEventListener('click', () => {
            submitConfirmModal.style.display = 'none';
        });

        finalSubmitBtn.addEventListener('click', async () => {
            finalSubmitBtn.disabled = true;
            finalSubmitBtn.innerText = "Saving...";

            const name = document.getElementById('userName').value;
            const category = document.getElementById('userCategory').value;
            const pref = document.getElementById('preference').value;
            const examList = Object.entries(verifiedData).map(([k, v]) => ({ name: k, roll: v.roll, marks: v.marks }));

            try {
                await addDoc(collection(db, "candidates_data"), {
                    name: name, 
                    category: category, // SAVE CATEGORY
                    exams: examList, 
                    preference: pref, 
                    deviceId: myDeviceId, 
                    timestamp: serverTimestamp()
                });

                submitConfirmModal.style.display = 'none';
                checkSubmissionStatus(); 
                alert("Data saved successfully!");

            } catch (err) {
                alert("Error: " + err.message);
                finalSubmitBtn.disabled = false;
                finalSubmitBtn.innerText = "Final Submit";
            }
        });

        // --- TABLE RENDER ---
        function applyFilters() {
            const activeFilters = Array.from(document.querySelectorAll('.filter-opt:checked')).map(b => b.value);
            const filtered = globalServerData.filter(user => {
                if (activeFilters.length === 0) return true;
                return activeFilters.every(f => user.exams.some(ue => ue.name === f));
            });
            document.getElementById('resultCount').innerText = `${filtered.length} Students`;
            renderTable(filtered);
        }

        function renderTable(data) {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';
            if(data.length === 0) { document.getElementById('noDataMsg').style.display = 'block'; return; }
            document.getElementById('noDataMsg').style.display = 'none';

            data.forEach(user => {
                const tr = document.createElement('tr');
                const examsHtml = user.exams.map(e => {
                    const style = (e.name === user.preference) ? "border-color:green; background:#f0fdf4;" : "";
                    return `<div class="data-badge" style="${style}"><span class="badge-exam">${e.name}</span><span class="badge-roll">Roll: ${e.roll}</span><span class="badge-marks">${e.marks} Marks</span></div>`;
                }).join('');
                
                // Name Column with Category Badge
                const nameCell = `
                    <div style="font-weight:bold;">${user.name}</div>
                    <span class="cat-badge">${user.category || 'N/A'}</span>
                `;

                tr.innerHTML = `<td>${nameCell}</td><td>${examsHtml}</td><td style="color:green;font-weight:bold">${user.preference}</td>`;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
